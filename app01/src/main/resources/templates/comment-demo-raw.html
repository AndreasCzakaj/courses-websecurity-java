<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Vulnerable Comment Demo - Server-Side Rendering</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .warning { background: #ffebee; padding: 20px; border-left: 4px solid #f44336; margin: 20px 0; }
        .demo-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 4px; }
        .vulnerable { background: #fff3e0; border-left: 4px solid #ff9800; }
        .comment-form { background: #fafafa; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .comment { background: white; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        .comment-meta { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        input[type="text"], textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 8px 16px; margin: 5px; }
        .nav-buttons { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>❌ Vulnerable: Stored XSS Demo (Server-Side Rendering)</h1>

    <div class="warning">
        <strong>⚠️ Stored XSS Vulnerability!</strong> Comments are rendered with <code>th:utext</code> - HTML content executes!
    </div>

    <div class="demo-section vulnerable">
        <h2>Comments Section (Vulnerable - Server-Side Rendering)</h2>

        <div class="comment-form">
            <h3>Add Comment</h3>
            <p><strong>Try malicious payload:</strong> <code>&lt;img src=x onerror=alert('Stored XSS!')&gt;</code></p>
            <form id="commentForm" onsubmit="submitComment(event)">
                <input type="text" id="author" placeholder="Your name" required />
                <textarea id="content" rows="3" placeholder="Your comment..." required></textarea>
                <button type="submit">Add Comment</button>
            </form>
        </div>

        <h3>Comments (Server-Side - Vulnerable)</h3>
        <div class="comments">
            <div th:each="comment : ${comments}" class="comment">
                <div class="comment-meta">
                    <strong th:text="${comment.author}">Author</strong> -
                    <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">Date</span>
                </div>
                <!-- VULNERABLE: Using th:utext renders raw HTML -->
                <div th:utext="${comment.content}">Comment content with raw HTML</div>
            </div>
            <div th:if="${#lists.isEmpty(comments)}">
                <p>No comments yet. Be the first to comment!</p>
            </div>
        </div>
    </div>

    <div class="nav-buttons">
        <a href="/demo"><button>← Back to Demo</button></a>
        <a href="/comment-safe"><button>View Safe Version →</button></a>
    </div>

    <script>
        async function submitComment(event) {
            event.preventDefault();

            const author = document.getElementById('author').value;
            const content = document.getElementById('content').value;

            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        author: author,
                        content: content
                    })
                });

                if (response.ok) {
                    // Reload page to show new comment
                    window.location.reload();
                } else {
                    alert('Failed to add comment');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding comment');
            }
        }
    </script>
</body>
</html>